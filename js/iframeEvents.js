class OcrHandler{constructor(){this.helpers=new helperSG;this.extPrefix="OCR_";this.dashboard="https://capios.ai";this.api="https://api.capios.ai";this.filetype=null;this.resultImage=null;this.OcrData=null;this.resultLanguage=null;this.resultTextOnly=null;this.resultText=null;this.editedText=null;this.isLoggedIn=false;this.sessionData=null;this.extractDocsIcon=chrome.runtime.getURL("../images/iframeIcons/docs-icon.png");this.extractPdfIcon=chrome.runtime.getURL("../images/iframeIcons/pdf-icon.png");this.eyeIcon=chrome.runtime.getURL("/images/eye-icon-pass.png");this.eyeIconDis=chrome.runtime.getURL("/images/eye-icon-dis-pass.png");this.searchIcon=chrome.runtime.getURL("../images/iframeIcons/ocr-search-icon.png");this.translateIcon=chrome.runtime.getURL("../images/iframeIcons/ocr-translate-icon.png");this.textToSpeechIcon=chrome.runtime.getURL("../images/iframeIcons/ocr-volume-icon.png");this.aiIcon=chrome.runtime.getURL("../images/iframeIcons/ocr-ai-icon.png");this.ocrBackIcon=chrome.runtime.getURL("../images/back-icon-black.png");this.closeIcon=chrome.runtime.getURL("../images/iframeIcons/ocr-close-icon.png");this.iframeDoc=document;this.initialize()}initialize(){this.init();this.setupMessageListener();this.setupEventListeners();this.handleOcrResultEvents()}init=()=>{chrome.storage.local.get(`${this.extPrefix}tessaractData`,result=>{let tessaractData=JSON.parse(result[`${this.extPrefix}tessaractData`]);let contentWithLineBreaks=tessaractData.content.replace(/\n/g,"<br>");this.resultText=contentWithLineBreaks;this.filetype=tessaractData.filetype;this.setupIcons();this.setupDropdown();document.querySelector(".ocrResulContainer .ocrResulText").innerHTML=contentWithLineBreaks;if(tessaractData.filetype!="Word OCR"&&tessaractData.filetype!="PDF OCR"){const imgElement=document.querySelector(".ocrMidInner .ocrCapturedImage");imgElement.addEventListener("load",function(){imgElement.style.width="95%"});imgElement.src=tessaractData.imageData}});localStorage.removeItem("ocrdataSaved");localStorage.removeItem("ocrSavedId");chrome.storage.local.get(`${this.extPrefix}result-image`,result=>{let resultImage=result[`${this.extPrefix}result-image`];this.imageData=resultImage});chrome.storage.local.get(`${this.extPrefix}resultLanguage`,result=>{let resultLanguage=JSON.parse(result[`${this.extPrefix}resultLanguage`]);this.resultLanguage=resultLanguage});chrome.storage.local.get(`${this.extPrefix}resultText`,result=>{let resultText=result[`${this.extPrefix}resultText`];this.resultTextOnly=resultText});chrome.storage.local.get(`${this.extPrefix}uploadedFile`,result=>{let uploadedFile=JSON.parse(result[`${this.extPrefix}uploadedFile`]);this.OcrData=uploadedFile});chrome.storage.local.get(`${this.extPrefix}quixyLoginUserData`,result=>{if(result[`${this.extPrefix}quixyLoginUserData`]!==""&&result[`${this.extPrefix}quixyLoginUserData`]!==null&&result[`${this.extPrefix}quixyLoginUserData`]!==undefined){document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML="Save";localStorage.setItem("OcrUserLoginIN",JSON.stringify(result[`${this.extPrefix}quixyLoginUserData`]))}else{document.querySelector(".ocrFooter .uploadOcrData").classList.add("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML="Login and Save";localStorage.removeItem("OcrUserLoginIN")}});chrome.storage.local.get([`${this.extPrefix}userSettings`],result=>{if(result[`${this.extPrefix}userSettings`]){const{extension_name,extension_logo,ocr_capture,capture,recorder,powered_by_logo,updated_at}=result[`${this.extPrefix}userSettings`];if(ocr_capture){if(ocr_capture.title){document.querySelector(".ocrTopInner span.Ocr-name").innerText=ocr_capture.title}if(ocr_capture.fullPage){const name=ocr_capture.fullPage;document.querySelector('.dropdown-options .dropdown-option[id="1"]').setAttribute("data-text",name);document.querySelector('.dropdown-options .dropdown-option[id="1"]').setAttribute("title",name);document.querySelector('.dropdown-options .dropdown-option[id="1"]').innerText=name}if(ocr_capture.selectArea){const name=ocr_capture.selectArea;document.querySelector('.dropdown-options .dropdown-option[id="3"]').setAttribute("data-text",name);document.querySelector('.dropdown-options .dropdown-option[id="3"]').setAttribute("title",name);document.querySelector('.dropdown-options .dropdown-option[id="3"]').innerText=name}if(ocr_capture.uploadFile){const name=ocr_capture.uploadFile;document.querySelector('.dropdown-options .dropdown-option[id="4"]').setAttribute("data-text",name);document.querySelector('.dropdown-options .dropdown-option[id="4"]').setAttribute("title",name);document.querySelector('.dropdown-options .dropdown-option[id="4"]').innerText=name}}}});chrome.storage.local.get([`${this.extPrefix}userSettings`],async result=>{if(result[`${this.extPrefix}userSettings`]){let{extension_name,extension_ui,extension_logo,powered_by_logo,logo,updated_at}=result[`${this.extPrefix}userSettings`];document.title=extension_name;document.querySelectorAll(".quix-change-bg-color").forEach(item=>{item.style.backgroundColor=extension_ui.containerBgColor})}})};setupMessageListener(){chrome.runtime.onMessage.addListener((message,sender,sendResponse)=>{if(message.type==="storageUpdate"){document.querySelector("#quix-popup-loader").style.display="none";const updatedUserAuth=message.newValue;if(updatedUserAuth)localStorage.setItem("OcrUserLoginIN",JSON.stringify(updatedUserAuth));if(!updatedUserAuth){localStorage.removeItem(`${this.extPrefix}screenGeniusAuthToken`);localStorage.removeItem(`${this.extPrefix}screenGeniusUserID`);localStorage.removeItem(`${this.extPrefix}screenGeniusUserRole`);localStorage.removeItem("OcrUserLoginIN")}const isLoggedIn=Object.keys(JSON.parse(localStorage.getItem("OcrUserLoginIN")||"{}")).includes("id");this.isLoggedIn=isLoggedIn;if(this.isLoggedIn)this.sessionData=JSON.parse(localStorage.getItem("OcrUserLoginIN"));const saved=localStorage.getItem("ocrdataSaved");if(saved=="true"){document.querySelector(".ocrFooter .uploadOcrData").classList.add("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML=`<a href="${this.dashboard}/dashboard#ocr-snippets" target=_blank>Dashboard</a>`;return}if(updatedUserAuth&&saved!="true"){document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML="Save"}else if(!updatedUserAuth&&saved!="true"){document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML="Login and Save"}}else if(message.type==="requestToLoginForOcrIframeRes"){console.log("iframeEvents:  requestToLoginForOcrIframeRes");this.helpers.checkForLogin(document)}else if(message.type==="removeLoaderFromIframeScreen"){console.log("----removeLoaderFromIframeScreen-------");document.querySelector("#quix-popup-loader").style.display="none"}else if(message.type==="requestToUploadDataForOcrIframeRes"){console.log("----requestToUploadDataForOcrIframeRes-------")}})}setupIcons=()=>{if(this.filetype==="Word OCR"){document.querySelector(".ocrMid .ocrMidInnerSection .ocrCapturedImage").setAttribute("src",this.extractDocsIcon);document.querySelector(".ocrMidInner .ocrCapturedImage").style.width="95%"}else if(this.filetype==="PDF OCR"){document.querySelector(".ocrMid .ocrMidInnerSection .ocrCapturedImage").setAttribute("src",this.extractPdfIcon);document.querySelector(".ocrMidInner .ocrCapturedImage").style.width="95%"}};setupDropdown=()=>{const iframeDoc=document;const dropdown=document.getElementById("dropdown");const selected=dropdown.querySelector(".dropdown-selected");const options=dropdown.querySelector(".dropdown-options");const selectedText=dropdown.querySelector("#selected-text");const selectedIcon=dropdown.querySelector("#selected-icon");let firstOption=null;if(this.filetype==="Full Page OCR"){firstOption=dropdown.querySelector('.dropdown-option[id="1"]')}else if(this.filetype==="Select Area OCR"){firstOption=dropdown.querySelector('.dropdown-option[id="3"]')}else if(this.filetype==="Upload OCR"||this.filetype==="PDF OCR"||this.filetype==="Word OCR"){firstOption=dropdown.querySelector('.dropdown-option[id="4"]')}else{firstOption=dropdown.querySelector(".dropdown-option")}selectedText.textContent=firstOption.getAttribute("data-text");selectedIcon.src=firstOption.getAttribute("data-icon");selected.id=firstOption.id;selected.addEventListener("click",()=>{dropdown.classList.toggle("open")});document.addEventListener("click",e=>{if(!dropdown.contains(e.target)){dropdown.classList.remove("open")}});const optionElements=dropdown.querySelectorAll(".dropdown-option");optionElements.forEach(option=>{option.addEventListener("click",()=>{selectedText.textContent=option.getAttribute("data-text");selectedIcon.src=option.getAttribute("data-icon");selected.id=option.id;dropdown.classList.remove("open")})})};setupEventListeners(){document.querySelector(".ocrTopSection.closeIframe").addEventListener("click",this.closeIframe.bind(this));document.querySelector(".OCR_new-capture-container button").addEventListener("click",this.handleRecapture.bind(this));document.querySelector(".ocrResulEventsChild .copyText").addEventListener("click",this.copyText.bind(this));document.querySelector(".ocrResulEvents .deleteText").addEventListener("click",this.deleteText.bind(this));document.querySelector(".ocrFooter .uploadOcrData").addEventListener("click",this.uploadOcrData.bind(this));document.querySelector(".ocrResulEventsChild .editText").addEventListener("click",this.handleEditText.bind(this));document.querySelector(".ocrFooterInner .searchResult").addEventListener("click",async()=>{const eventPageData=this.OCRsearchConfig;document.querySelector(".ocrParentContainer.firstPage").style.display="none";const textElement=document.querySelector(".ocrResulContainer .ocrResulText").innerHTML;const iframeOptions=new IframeOptions(this.iframe,document,{showEventPage:"showEventPage",showOcrMainPage:"showOcrMainPage",eventPageData:eventPageData,resultTextRef:textElement,resultImage:this.resultImage,languageSelected:document.querySelector("#languageSelected"),ocrBackIcon:this.ocrBackIcon,closeIcon:this.closeIcon});iframeOptions.createOcrOptionsPage()})}closeIframe(){localStorage.removeItem("ocrdataSaved");localStorage.removeItem("ocrSavedId");chrome.storage.local.remove([`${this.helpers.extPrefix}tessaractData`,`${this.helpers.extPrefix}isToShow`,`${this.helpers.extPrefix}result-image`,`${this.helpers.extPrefix}resultLanguage`,`${this.helpers.extPrefix}resultText`,`${this.helpers.extPrefix}uploadedFile`],()=>{});document.body.style.display="none";chrome.tabs.query({active:true,currentWindow:true},function(tabs){chrome.tabs.sendMessage(tabs[0].id,{type:"remove-ocr-elems-present-in-screen"})})}handleRecapture=async()=>{const mode="ocr";const id=parseInt(document.querySelector(".OCR_dropdown-container .dropdown-selected").id);chrome.tabs.query({active:true,currentWindow:true},function(tabs){console.log(tabs[0].id,"--handleRecapture--",id);chrome.tabs.sendMessage(tabs[0].id,{type:"remove-ocr-elems-present-in-screen"})});localStorage.getItem("ocrdataSaved");if(id==3){chrome.tabs.query({active:true,currentWindow:true},function(tabs){chrome.tabs.sendMessage(tabs[0].id,{type:"captureVisiblePartRequestFromIframe",data:{id:id,mode:mode,recapture:true}})})}else{chrome.tabs.query({active:true,currentWindow:true},function(tabs){chrome.tabs.sendMessage(tabs[0].id,{type:"requestToCaptureForOcrFromIframe",data:{id:id,mode:mode,recapture:true}})})}if(chrome.runtime.lastError){console.error("Message send failed----------:",chrome.runtime.lastError.message)}else{console.log("Message sending initiated successfully.---------")}};copyText(){const textElement=document.querySelector(".ocrResulContainer .ocrResulText");if(textElement){const range=document.createRange();range.selectNodeContents(textElement);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);textElement.classList.add("selectedText");navigator.clipboard.writeText(textElement.innerText).then(()=>{document.querySelector(".ocrResulEventsChild .copyMessage").style.display="block";setTimeout(()=>{selection.removeAllRanges();document.querySelector(".ocrResulEventsChild .copyMessage").style.display="none";textElement.classList.remove("selectedText")},500)})["catch"](err=>{console.log("Failed to copy content")})}}deleteText(){document.querySelector(".ocrResulContainer .ocrResulText").innerHTML="";chrome.storage.local.remove(`${this.helpers.extPrefix}resultText`)}async uploadOcrData(){const uploadOcrDataElement=document.querySelector(".ocrFooter .uploadOcrData");uploadOcrDataElement.style.pointerEvents="none";setTimeout(()=>{uploadOcrDataElement.style.pointerEvents="all"},2e3);const checkOcrDataSaved=localStorage.getItem("ocrdataSaved");if(checkOcrDataSaved=="true"){uploadOcrDataElement.classList.add("saved");uploadOcrDataElement.innerHTML=`<a href="${this.helpers.dashboard}/dashboard#ocr-snippets" target=_blank>Dashboard</a>`;return}uploadOcrDataElement.classList.remove("saved");uploadOcrDataElement.innerText="Loading..";const isLoggedIn=Object.keys(JSON.parse(localStorage.getItem("OcrUserLoginIN")||"{}")).includes("id");if(isLoggedIn){const sessionData=JSON.parse(localStorage.getItem("OcrUserLoginIN"));this.helpers.uploadOcrDataHandler(sessionData,document)}else{document.querySelector("#quix-popup-loader").style.display="block";chrome.runtime.sendMessage({type:"requestToLoginForOcrIframe"},function(res){});uploadOcrDataElement.innerText="Login and Save"}}handleEditText(){const resultTextRef=document.querySelector(".ocrResulContainer .ocrResulText");this.editedText=resultTextRef.innerHTML;document.querySelector(".ocrMidInnerSection .ocrResulText").style.display="none";document.querySelector(".ocrMidInnerSection .ocrResulEvents").style.display="none";document.querySelector(".editorContentParent").style.display="block";document.querySelector(".editorContentParent #editorQuill").innerHTML="";document.querySelector(".ocrFooter").style.display="none";document.querySelector(".ocrFooter.ocrFooterEdit").style.display="flex";document.querySelector(".ocrFooter.ocrFooterEdit .cancelEdit").removeEventListener("click",this.removeTextArea);document.querySelector(".ocrFooter.ocrFooterEdit .cancelEdit").addEventListener("click",this.removeTextArea);document.querySelector(".ocrFooter.ocrFooterEdit .cancelEdit").removeEventListener("click",this.saveEditTextHandler);document.querySelector(".ocrFooter.ocrFooterEdit .saveEdit").addEventListener("click",this.saveEditTextHandler);const toolbox=document.querySelector(".ql-toolbar.ql-snow");if(toolbox)toolbox.remove();const editorContainer=document.querySelector(".editorContentParent #editorQuill");const quill=new Quill(editorContainer,{theme:"snow",modules:{toolbar:{container:[[{header:[1,2,3,false]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}]]}}});const defaultContent=document.querySelector(".ocrResulContainer .ocrResulText").innerHTML;if(defaultContent){quill.clipboard.dangerouslyPasteHTML(defaultContent)}else{console.warn("No default content found to paste into Quill editor.")}quill.on("text-change",(delta,oldDelta,source)=>{this.editedText=quill.root.innerHTML})}saveEditTextHandler=()=>{const resultTextRef=document.querySelector(".ocrResulContainer .ocrResulText");if(this.editedText.trim()==resultTextRef.innerHTML.trim()){this.removeTextArea()}else{resultTextRef.innerHTML=this.editedText;localStorage.removeItem("ocrdataSaved");if(this.isLoggedIn){document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Save"}else if(!this.isLoggedIn){document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Login and Save"}document.querySelector(".ocrMidInnerSection .ocrResulText").style.display="block";document.querySelector(".ocrMidInnerSection .ocrResulEvents").style.display="flex";document.querySelector(".editorContentParent").style.display="none";document.querySelector(".ocrFooter").style.display="flex";document.querySelector(".ocrFooter.ocrFooterEdit").style.display="none"}};removeTextArea=()=>{document.querySelector(".ocrMidInnerSection .ocrResulText").style.display="block";document.querySelector(".ocrMidInnerSection .ocrResulEvents").style.display="flex";document.querySelector(".editorContentParent").style.display="none";document.querySelector(".ocrFooter").style.display="flex";document.querySelector(".ocrFooter.ocrFooterEdit").style.display="none"};handleLoginPopup(){document.querySelector(".login-share-popup #toggle-password").addEventListener("click",()=>{const passwordInput=document.querySelector(".traditional-password-wrapper #password");const eyeIcon=document.querySelector(".traditional-password-wrapper #toggle-password");if(passwordInput.type==="password"){passwordInput.type="text";eyeIcon.src=`${this.helpers.eyeIcon}`}else{passwordInput.type="password";eyeIcon.src=`${this.helpers.eyeIconDis}`}});document.querySelector(".login-share-popup .traditional-button-wrapper button").addEventListener("click",event=>{const email=document.querySelector(".traditional-username-wrapper input").value.trim();const password=document.querySelector(".traditional-password-wrapper input").value.trim();const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!email||!password){this.displayLoginError("Please Enter email and password");return}if(!emailRegex.test(email)){this.displayLoginError("Invalid Email");return}document.querySelector("#login-share-popup-wrapper").remove();this.helpers.loginUser(email,password)})}handleOcrResultEvents=()=>{const html=`<div class="quix-popup-outer quix-fullscreen-loader" style="display: block;">
        <div class="quix-fullscreen-loader-inner"><div class="quix-not-available-message"><h3>Full Page Capturing.</h3><div class="quix-fullscreen-loader-progress"><div class="quix-fullscreen-loader-progress-inner"></div></div><p>Please <b>do not scroll</b> or move your mouse pointer while capturing in order to get the best result.</p></div></div></div>`};handleUploadOcrData=async()=>{let sessionData=null;const isLoggedIn=Object.keys(JSON.parse(localStorage.getItem("OcrUserLoginIN")||"{}")).includes("id");if(isLoggedIn){sessionData=JSON.parse(localStorage.getItem("OcrUserLoginIN"))}else{document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Save";return false}chrome.storage.local.get(`${this.extPrefix}uploadedFile`,async result=>{const storedData=result[`${this.extPrefix}uploadedFile`];if(storedData){try{const parsedData=JSON.parse(storedData);if(parsedData.type){}const savedId=localStorage.getItem("ocrSavedId");if(savedId){parsedData.ocr_id=savedId}const resultText=iframeDoc.querySelector(".ocrParentContainer.firstPage .ocrResulContainer .ocrResulText").innerHTML;parsedData.user_id=sessionData.id;parsedData.access_token=sessionData.access_token;parsedData.text=resultText;const response=await fetch(_this.api+"/ocr/upload-data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(parsedData)});if(!response.ok){const responseData=await response.json();if(!responseData.status&&responseData.message=="Access denied!"){chrome.storage.local.remove(`${_this.extPrefix}quixyLoginUserData`,function(){});localStorage.removeItem("OcrUserLoginIN");localStorage.removeItem(`${this.extPrefix}screenGeniusAuthToken`);document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Login and Save"}throw new Error("Network response was not ok")}const responseData=await response.json();if(responseData.status){localStorage.setItem("ocrdataSaved",true);localStorage.setItem("ocrSavedId",responseData.data.id);document.querySelector(".ocrFooter .uploadOcrData").classList.add("saved");document.querySelector(".ocrFooter .uploadOcrData").innerHTML=`<a href="${this.dashboard}/dashboard#ocr-snippets" target=_blank>Dashboard</a>`}else{document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Save"}return true}catch(error){console.error("Error parsing stored data:",error);return false}}else{document.querySelector(".ocrFooter .uploadOcrData").classList.remove("saved");document.querySelector(".ocrFooter .uploadOcrData").innerText="Save";return false}})};OCRsearchConfig={title:"search",icon:this.searchIcon,main:"Search",section1Header:"Enter Word to search",section2Header:"OCR Capture Result"};OCRtranslateConfig={title:"translate",icon:"translateIcon",main:"Translate",section1Header:"English-UK",section2Header:"Punjabi"};OCRtextSpeachConfig={title:"textToSpeech",icon:"volumeIcon",main:"Text to Speech",section1Header:"English-UK",section2Header:"null"};OCRinterrogationConfig={title:"interrogation",icon:"questionIcon",main:"Knowledge base Inventory",section1Header:"",section2Header:"Your Question/Query"};OCRaskAiConfig={title:"AskAI",icon:"aiIcon",main:"Ask AI",section1Header:"",section2Header:"Your Question/Query"}}document.addEventListener("DOMContentLoaded",()=>{const ocrHandler=new OcrHandler});